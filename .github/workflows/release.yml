name: Release Binaries

on:
  push:
    tags:
      - "go-v*"

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      # 1. リポジトリのコードをチェックアウト
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # タグの履歴をすべて取得 (GoReleaserが変更履歴を検出するため)
          fetch-depth: 0

      # 2. Go言語環境のセットアップ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ./go/go.mod
          cache-dependency-path: ./go/go.sum

      # 3. タグ名から 'go-' プレフィックスを除去する
      - name: Set clean tag name
        id: tag_name
        run: |
          TAG_NAME="${{ github.ref_name }}"
          echo "tag=${TAG_NAME#go-}" >> $GITHUB_OUTPUT

      # 4. GoReleaser アクションを実行
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          # goreleaserのバージョン指定
          version: "~> v2"
          # .goreleaser.yml の 'builds' セクションを実行
          args: release --clean --skip=validate # tag名を書き換えているので validate はスキップ
          workdir: ./go
        env:
          # リリースを作成・アップロードするために必要なトークン
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # tag名のプレフィックスを無視するための環境変数を設定
          # https://goreleaser.com/cookbooks/set-a-custom-git-tag/
          GORELEASER_CURRENT_TAG: ${{ steps.tag_name.outputs.tag }}
